# 自动归档脚本手动测试

虽然大部分代码已经被单元测试覆盖到了，但是主要的main函数以及部分函数可能仍然未覆盖到，
且由于集成测试编写难度过大，暂且写不出来。
所以当代码有大量改动时，建议手动在此仓库的Issue中对归档流水线进行测试

## 测试用例

> [!WARNING]
> 由于Github和Gitlab两个平台的接口存在差异
> 所以归档脚本实现方式不一致
> 若有时间，最好是Github和Gitlab两侧流水线都进行手动测试

## 自动归档流水线测试用例

> [!NOTE]
> 在测试前，要确认对应的issue单号是否已经写入`修改归档.md`了,
> 如果某个issue满足归档条件时被close且已经归档过了，关闭issue后，归档流水线会留下类似评论：
> `外部Issue#xxx 已存在归档记录，无需再次归档，跳过归档流程`

建议从上往下逐一添加或者移除某些内容，关闭issue并观察归档流水线的行为是否符合预期：
|                 描述                  |                    标签                     |        评论        |                        关闭issue预期效果                        |
| :-----------------------------------: | :-----------------------------------------: | :----------------: | :-------------------------------------------------------------: |
|                  无                   |                     无                      |         无         |                归档流水线无视此状态，issue被关闭                |
|   包含“【发现版本号】：0.99.954b9 ”   |                     无                      |         无         |                归档流水线无视此状态，issue被关闭                |
|   包含“【发现版本号】：0.99.954b9 ”   |                    “bug”                    |         无         |                归档流水线无视此状态，issue被关闭                |
|   包含“【发现版本号】：0.99.954b9 ”   |                     无                      | “0.99.955测试通过” |                归档流水线无视此状态，issue被关闭                |
|   包含“【发现版本号】：0.99.954b9 ”   |              “resolved 已解决”              |         无         |         issue被重新打开，并评论“找不到归档版本号关键字”         |
|   包含“【发现版本号】：0.99.954b9 ”   |              “resolved 已解决”              | “0.99.955测试通过” |          issue被重新打开，并评论“找不到Issue类型标签”           |
|                  无                   |          “resolved 已解决”，“bug”           | “0.99.955测试通过” |            issue被重新打开，并评论“找不到引入版本号”            |
|   包含“【发现版本号】：0.99.954b9 ”   |                    “bug”                    | “0.99.955测试通过” |           issue被重新打开，并评论“找不到归档所需标签”           |
|   包含“【发现版本号】：0.99.954b9 ”   |       “bug”，“enhancement 优化或建议”       | “0.99.955测试通过” |        issue被重新打开，并评论“匹配到多个Issue类型标签”         |
| 包含两个“【发现版本号】：0.99.954b9 ” |                    “bug”                    | “0.99.955测试通过” |         issue被重新打开，并评论“匹配到多个版本号关键字”         |
|                  无                   | “resolved 已解决”，“enhancement 优化或建议” | “0.99.955测试通过” | issue被正常关闭且被正确归档，并评论“外部Issue#XXX 自动归档成功” |
|   包含“【发现版本号】：0.99.954b9 ”   |          “resolved 已解决”，“bug”           | “0.99.955测试通过” | issue被正常关闭且被正确归档，并评论“外部Issue#XXX 自动归档成功” |

由于 gitlab ci 流水线触发实现条件与 github action 完全不一致，所以 gitlab流水线 需要一些额外的测试

| 测试用例                                                     | 预期效果                                               |
| ------------------------------------------------------------ | ------------------------------------------------------ |
| 重新打开（reopen）一个issue                                  | 归档流水线被触发，然后流水线成功执行，但是没有任何行为 |
| 修改（update）一个issue，更新issue描述或者标题（加一个空格） | 归档流水线被触发，然后流水线成功执行，但是没有任何行为 |

## 手动归档流水线测试用例

> [!NOTE]
> 在测试前，要确认对应的issue单号是否已经写入`修改归档.md`了,
> 如果在满足归档所需条件的情况下手动运行归档流水线，归档流水线则不会因为issue已经被归档过而跳过归档流程，
> 若要归档的Issue还没被写入归档文件，则正常追加内容到归档文件中；
> 若要归档的Issue已写入过归档文件，此时会将手动输入归档流水线变量的内容覆盖到已经存在的归档条目中

以下为手动运行归档流水线，但归档信息在issue中获取的情况
| 手动填入的变量 |               描述                |                    标签                     |        评论        | 预期                                                                                                                                  |
| :------------: | :-------------------------------: | :-----------------------------------------: | :----------------: | :------------------------------------------------------------------------------------------------------------------------------------ |
|  “Issue单号”   |                无                 |                     无                      |         无         | issue被重新打开，并评论“手动归档流水线试图归档此Issue，但并未手动填写归档版本号且未在Issue信息中获取到有效的归档版本号和归档所需标签” |
|  “Issue单号”   | 包含“【发现版本号】：0.99.954b9 ” |                     无                      |         无         | issue被重新打开，并评论“手动归档流水线试图归档此Issue，但并未手动填写归档版本号且未在Issue信息中获取到有效的归档版本号和归档所需标签” |
|  “Issue单号”   | 包含“【发现版本号】：0.99.954b9 ” |                    “bug”                    |         无         | issue被重新打开，并评论“手动归档流水线试图归档此Issue，但并未手动填写归档版本号且未在Issue信息中获取到有效的归档版本号和归档所需标签” |
|  “Issue单号”   | 包含“【发现版本号】：0.99.954b9 ” |                     无                      | “0.99.955测试通过” | issue被重新打开，并评论“找不到归档所需标签”                                                                                           |
|  “Issue单号”   | 包含“【发现版本号】：0.99.954b9 ” |              “resolved 已解决”              |         无         | issue被重新打开，并评论“找不到归档版本号关键字”                                                                                       |
|  “Issue单号”   | 包含“【发现版本号】：0.99.954b9 ” |              “resolved 已解决”              | “0.99.955测试通过” | issue被重新打开，并评论“找不到Issue类型标签”                                                                                          |
|  “Issue单号”   |                无                 |          “resolved 已解决”，“bug”           | “0.99.955测试通过” | issue被重新打开，并评论“找不到引入版本号”                                                                                             |
|  “Issue单号”   | 包含“【发现版本号】：0.99.954b9 ” |                    “bug”                    | “0.99.955测试通过” | issue被重新打开，并评论“找不到归档所需标签”                                                                                           |
|  “Issue单号”   |                无                 | “resolved 已解决”，“enhancement 优化或建议” | “0.99.955测试通过” | issue被正常关闭且被正确归档，并评论“外部Issue#XXX 自动归档成功”                                                                       |
|  “Issue单号”   | 包含“【发现版本号】：0.99.954b9 ” |          “resolved 已解决”，“bug”           | “0.99.955测试通过” | issue被正常关闭且被正确归档，并评论“外部Issue#XXX 自动归档成功”                                                                       |

> [!NOTE]
> 下面的测试，`Issue类型`只要不是`自动判断`，选择或者任填一个即可。在github流水线是选择，在gitlab流水线是填入字符串  

以下为归档信息手动填入的情况
|                   手动填入的变量                    | 描述  |       标签        | 评论  | 预期                                                                                                                                                              |
| :-------------------------------------------------: | :---: | :---------------: | :---: | :---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Issue单号,Issue标题,xxxxxxxxx,xxxxxxxxx,xxxxxxxxxx  |  无   |        无         |  无   | issue被重新打开，并评论“手动归档流水线试图归档此Issue，但并未手动填写归档版本号且未在Issue信息中获取到有效的归档版本号和归档所需标签”                             |
| Issue单号,Issue标题,xxxxxxxxx,归档版本号,Issue类型  |  无   |        无         |  无   | issue被重新打开，并评论“issue被重新打开，并评论“找不到引入版本号”                                                                                                 |
| Issue单号,Issue标题,引入版本号,xxxxxxxxx,Issue类型  |  无   |        无         |  无   | issue被重新打开，并评论“手动归档流水线试图归档此Issue，但并未手动填写归档版本号且未在Issue信息中获取到有效的归档版本号和归档所需标签”~~“找不到归档版本号关键字”~~ |
| Issue单号,Issue标题,引入版本号,归档版本号,xxxxxxxx  |  无   |        无         |  无   | issue被重新打开，并评论“找不到Issue类型标签”                                                                                                                      |
| Issue单号,Issue标题,引入版本号,归档版本号,Issue类型 |  无   |        无         |  无   | issue被正常关闭且被正确归档，并评论“外部Issue#XXX 自动归档成功”,归档新增内容为手动填入变量的值                                                                    |
| Issue单号,Issue标题,引入版本号,归档版本号,Issue类型 |  无   | “resolved 已解决” |  无   | issue被正常关闭且被正确归档，并评论“外部Issue#XXX 自动归档成功”,归档新增内容为手动填入变量的值                                                                    |

## 手动跳过归档流程

在issue中评论包含以下表格的任意一个关键字即可跳过归档流程

|    关键字    |
| :----------: |
| 跳过归档流程 |
