# rotate仓库token，文档：
# https://docs.gitlab.com/ee/api/project_access_tokens.html#rotate-a-project-access-token

# token权限文档：
# https://docs.gitlab.com/17.3/ee/user/project/settings/project_access_tokens.html#scopes-for-a-project-access-token

# 流水线调度器（schedules）文档：
# https://docs.gitlab.com/ee/ci/pipelines/schedules.html#edit-a-pipeline-schedule


cache:
  paths:
    - /usr/local/lib/python3.10/site-packages   # 系统包装在这里
    - /usr/local/uv                             # uv 二进制
  key: "$CI_COMMIT_REF_SLUG"

variables:
  GITLAB_HOST: $CI_SERVER_HOST       # example: gitlab.com
  PROJECT_ID: $CI_PROJECT_ID         # example: 123456  
  TOKEN_TTL_DAYS: 93                 # 单位：天
  TARGET_VARIABLE_NAME: TOKEN
  # PIP_MIRROR_URL: https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple  # 这个环境变量在AutoArchiving.yml定义了,但是这里也用得到
  # UV_SYSTEM_PYTHON: 1 # 这个环境变量在AutoArchiving.yml定义了,但是这里也用得到
  # UV_INDEX_URL: https://mirrors.aliyun.com/pypi/simple # 这个环境变量在AutoArchiving.yml定义了,但是这里也用得到

before_script:
  # 如果镜像里没 uv，就现装一个（用国内 pip 源）
  - command -v uv || pip install uv -i $PIP_MIRROR_URL

rotate_access_token:
  # image: m.daocloud.io/docker.io/library/python:3.10.13-slim-bullseye
  image: anolis-registry.cn-zhangjiakou.cr.aliyuncs.com/openanolis/python:3.10.13-23-minimal
  tags: 
    - ubuntu
  stage: rotate_access_token
  only:
    - schedules
  script: |
    uv pip install -r ./pyproject.toml --system
    python3 ./rn_issues_auto_archiving/utils/rotate_access_token.py
  
