cache:
  paths:
    - .cache/uv      # 轮子缓存
    - .local/bin/uv  # uv 本体缓存
  key: "$CI_COMMIT_REF_SLUG"

before_script:
  # 如果镜像里没 uv，就现装一个（用国内 pip 源）
  - export PATH="$CI_PROJECT_DIR/.local/bin:$PATH"  
  - |
    if [ ! -x "$UV_BIN" ]; then
      pip install --target "$CI_PROJECT_DIR/.local" uv -i "$PIP_MIRROR_URL"
    fi

unittest:
  tags: 
    - ubuntu
  stage: unittest
  rules:
    # 1. 触发器/WEB 一律不跑
    - if: '$CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "web"'
      when: never
    # 2. PUSH/MR 且 **至少改了一个 .py** → 跑
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "rn_issues_auto_archiving/**/*.py"
      when: on_success
    # 3. 其余情况（包括 PUSH/MR 但无 .py 改动）→ 不跑
    - when: never
  # image: m.daocloud.io/docker.io/library/python:3.10.13-slim-bullseye
  image: anolis-registry.cn-zhangjiakou.cr.aliyuncs.com/openanolis/python:3.10.13-23-minimal
  script: |
    uv pip install -r ./pyproject.toml --system --extra unittest
    pytest
