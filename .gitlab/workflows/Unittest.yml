variables:
  # PIP_MIRROR_URL: https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple  # 这个环境变量在AutoArchiving.yml定义了,但是这里也用得到
  # UV_SYSTEM_PYTHON: 1 # 这个环境变量在AutoArchiving.yml定义了,但是这里也用得到
  # UV_INDEX_URL: https://mirrors.aliyun.com/pypi/simple # 这个环境变量在AutoArchiving.yml定义了,但是这里也用得到


cache:
  paths:
    - ~/.cache/uv
    - ~/.local/bin/uv
  key: "$CI_COMMIT_REF_SLUG"

before_script:
  # 如果镜像里没 uv，就现装一个（用国内 pip 源）
  - command -v uv || pip install uv -i https://pypi.tuna.tsinghua.edu.cn/simple

unittest:
  tags: 
    - ubuntu
  stage: unittest
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger" 
      when: never
    - if: $CI_PIPELINE_SOURCE == "web"
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - rn_issues_auto_archiving/**/*.py
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - rn_issues_auto_archiving/**/*.py
  # image: m.daocloud.io/docker.io/library/python:3.10.13-slim-bullseye
  image: anolis-registry.cn-zhangjiakou.cr.aliyuncs.com/openanolis/python:3.10.13-23-minimal
  script: |
    uv pip install -r ./pyproject.toml --extra unittest
    pytest
